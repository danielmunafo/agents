name: Daily Trends

on:
  schedule:
    # Run every day at 02:00 UTC (to avoid peak hours)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger
    inputs:
      area:
        description: "Specific area to process (optional, processes all if not specified)"
        required: false
        type: choice
        options:
          - "All"
          - "General IT"
          - "Back end"
          - "Front end"
          - "AI, LLM and Machine learning"
          - "Database"
          - "DevOps and infrastructure"
          - "Architecture, governance and design"
          - "Testing and QA"

jobs:
  daily-trends:
    runs-on: ubuntu-latest

    strategy:
      # Run each area in parallel for efficiency
      matrix:
        area:
          - "General IT"
          - "Back end"
          - "Front end"
          - "AI, LLM and Machine learning"
          - "Database"
          - "DevOps and infrastructure"
          - "Architecture, governance and design"
          - "Testing and QA"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc-s1 \
            libglib2.0-0t64 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils

      - name: Create LinkedIn cookies file from secret
        run: |
          if [ -n "${{ secrets.LINKEDIN_COOKIES }}" ]; then
            echo "${{ secrets.LINKEDIN_COOKIES }}" > linkedin-cookies.json
            chmod 600 linkedin-cookies.json
            # Validate JSON format
            if ! python3 -m json.tool linkedin-cookies.json > /dev/null 2>&1; then
              echo "Error: LINKEDIN_COOKIES secret is not valid JSON"
              exit 1
            fi
            echo "LinkedIn cookies file created successfully"
          else
            echo "Warning: LINKEDIN_COOKIES secret not set - authentication will be required"
          fi
        env:
          LINKEDIN_COOKIES_PATH: linkedin-cookies.json

      - name: Run daily workflow for ${{ matrix.area }}
        # Skip this job if manually triggered with a specific area that doesn't match
        if: github.event_name != 'workflow_dispatch' || !github.event.inputs.area || github.event.inputs.area == 'All' || github.event.inputs.area == matrix.area
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LINKEDIN_COOKIES_PATH: linkedin-cookies.json
          NODE_ENV: production
          CI: true
          # When manually triggered with "All" or no area, the script runs all areas
          # When a specific area is selected, only pass that area
          AREA: "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.area && github.event.inputs.area != 'All' && github.event.inputs.area || matrix.area }}"
        run: npm run daily
